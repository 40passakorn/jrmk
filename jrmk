<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JRMK Catering System</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;700;900&display=swap');
        body { font-family: 'Kanit', sans-serif; }
        /* Fix for Google Sites iframe scrolling */
        html, body { height: 100%; overflow-y: auto; }
    </style>

    <!-- 2. Import Map for React & Firebase (Modules) -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
        }
    }
    </script>

    <!-- 3. Babel for JSX compilation in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <!-- 4. Main Application Script -->
    <script type="text/babel" data-type="module">
        import React, { useState, useMemo, useEffect, useCallback } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from 'firebase/auth';
        import { getFirestore, doc, setDoc, collection, serverTimestamp, onSnapshot, query, where, updateDoc, deleteDoc, getDocs } from 'firebase/firestore';

        // ==========================================
        //  ⚠️ การตั้งค่า Firebase (Configuration) ⚠️
        // ==========================================
        
        let activeConfig = null;
        let activeAppId = 'jrmk-production';

        // 1. พยายามดึง Config จากสภาพแวดล้อม (สำหรับหน้า Preview นี้โดยเฉพาะ)
        try {
            if (typeof __firebase_config !== 'undefined') {
                activeConfig = JSON.parse(__firebase_config);
                if (typeof __app_id !== 'undefined') activeAppId = __app_id;
                console.log("Using Environment Config");
            }
        } catch (e) { console.log("Environment config not available"); }

        // 2. Config สำหรับ Google Sites (คุณต้องแก้ไขค่าตรงนี้เมื่อนำไปใช้งานจริง!)
        const manualConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Logic การเลือก Config: ถ้ามีใน Env ให้ใช้ก่อน (เพื่อให้ Preview ทำงานได้) ถ้าไม่มีให้ใช้ manualConfig
        const firebaseConfig = activeConfig || manualConfig;
        const appId = activeAppId;

        // ==========================================
        //  จบส่วนการตั้งค่า
        // ==========================================

        // --- Hashing Utility ---
        const HASH_SALT = 'TohChinSecretSalt123';
        const hashPassword = (password) => {
            const combined = password + HASH_SALT;
            return btoa(combined).substring(0, 100); 
        };

        // --- Data Definitions ---
        const packagesData = [
            { id: 'standard', name: 'มงคล (Standard)', price: 3990, features: ['เมนูเริ่มต้น 8 อย่าง', 'เครื่องดื่มสมุนไพร', 'บริการตกแต่งดอกไม้ (ไม่มี)'] },
            { id: 'premium', name: 'มั่งคั่ง (Premium)', price: 5990, features: ['เมนูพรีเมียม 10 อย่าง', 'เครื่องดื่มซอฟต์ดริงค์/น้ำสมุนไพรไม่อั้น', 'ฟรี! บริการตกแต่งดอกไม้'], isRecommended: true },
            { id: 'exclusive', name: 'จักรพรรดิ (Exclusive)', price: 7990, features: ['เมนูซิกเนเจอร์ 12 อย่าง (ปรับได้)', 'เครื่องดื่มและมิกเซอร์ครบชุด', 'ที่ปรึกษาการจัดเลี้ยงส่วนตัว'] },
        ];

        const addonsData = [
            { id: 'addon1', name: 'ข้าวผัดหยางโจว', price: 450, description: 'ข้าวหอมมะลิผัดกับกุ้ง หมูแดง และเครื่องเทศอย่างลงตัว' },
            { id: 'addon2', name: 'ซุปเสฉวนรสเผ็ด', price: 550, description: 'ซุปร้อนๆ รสชาติเผ็ดเปรี้ยว กลมกล่อม สไตล์เสฉวนแท้ๆ' },
            { id: 'addon3', name: 'ขาหมูยัดไส้ (หนึ่งขา)', price: 1500, description: 'ขาหมูตุ๋นจนเปื่อยนุ่ม ยัดไส้ด้วยเห็ดหอมและสมุนไพรจีน' },
            { id: 'addon4', name: 'สลัดกุ้งมังกร (พรีเมียม)', price: 4500, description: 'เมนูพิเศษสำหรับงานหรูหรา กุ้งมังกรสดๆ เสิร์ฟพร้อมน้ำสลัดสูตรเฉพาะ' },
        ];

        const banksData = [
            { id: 'kbank', name: 'ธนาคารกสิกรไทย', color: 'bg-green-600', accName: 'บจก. เจริญมงคล', accNo: '000-1-23456-7' },
            { id: 'scb', name: 'ธนาคารไทยพาณิชย์', color: 'bg-purple-600', accName: 'บจก. เจริญมงคล', accNo: '111-2-34567-8' },
            { id: 'ktb', name: 'ธนาคารกรุงไทย', color: 'bg-blue-500', accName: 'บจก. เจริญมงคล', accNo: '222-3-45678-9' },
        ];

        const formatCurrency = (num) => num.toLocaleString('th-TH') + '.-';
        const ADMIN_USERNAME = 'admin';
        const ADMIN_PASSWORD = '1234';

        const ORDER_STATUSES = {
            'Pending Payment': { label: 'รอชำระเงิน', color: 'bg-gray-100 text-gray-800' },
            'Paid': { label: 'ชำระเงินแล้ว', color: 'bg-green-100 text-green-800' },
            'Confirmed': { label: 'ยืนยันการจัดงาน', color: 'bg-blue-100 text-blue-800' },
            'Canceled': { label: 'ยกเลิก', color: 'bg-red-100 text-red-800' },
            'Completed': { label: 'จัดงานเสร็จสิ้น', color: 'bg-gray-800 text-white' },
        };

        // --- Main Component ---
        function App() {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [user, setUser] = useState(null); 
            const [isAuthReady, setIsAuthReady] = useState(false);
            
            const [appMode, setAppMode] = useState('order');
            const [isAdminLoggedIn, setIsAdminLoggedIn] = useState(false);
            const [loginError, setLoginError] = useState('');

            const [selectedPackageId, setSelectedPackageId] = useState(null);
            const [selectedAddons, setSelectedAddons] = useState([]);
            const [tableQuantity, setTableQuantity] = useState(1);
            const [isOrderProcessing, setIsOrderProcessing] = useState(false);
            
            const [isPaymentSelectionOpen, setIsPaymentSelectionOpen] = useState(false);
            const [isSuccessModalOpen, setIsSuccessModalOpen] = useState(false);
            const [customerOrders, setCustomerOrders] = useState([]);
            const [errorMessage, setErrorMessage] = useState('');

            // Collection Paths (Use appId variable)
            const CUSTOMER_COLLECTION_PATH = `artifacts/${appId}/public/data/customers`;
            const ORDER_COLLECTION_PATH = `artifacts/${appId}/public/data/orders`;

            useEffect(() => {
                const initFirebase = async () => {
                    // Check if config is valid (either from Env or Manual)
                    // If apiKey is still the placeholder "YOUR_API_KEY", it means no config was found.
                    if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY") {
                        console.error("Firebase config missing. Please edit the code.");
                        setErrorMessage("⚠️ กรุณาตั้งค่า Firebase Config ในโค้ดก่อนใช้งาน (บรรทัดที่ 46)");
                        setIsAuthReady(true);
                        return;
                    }

                    try {
                        const app = initializeApp(firebaseConfig);
                        const firestoreDb = getFirestore(app);
                        const firebaseAuth = getAuth(app);

                        setDb(firestoreDb);
                        setAuth(firebaseAuth);

                        // Try to use custom token if available in environment (for preview)
                        let initialAuthToken = null;
                        if (typeof __initial_auth_token !== 'undefined') {
                            initialAuthToken = __initial_auth_token;
                        }

                        onAuthStateChanged(firebaseAuth, async (currentUser) => {
                            if (currentUser) {
                                setUser(currentUser);
                            } else {
                                if (initialAuthToken) {
                                    try {
                                        const result = await signInWithCustomToken(firebaseAuth, initialAuthToken);
                                        setUser(result.user);
                                    } catch (e) {
                                        console.warn("Custom token failed, using anonymous");
                                        const result = await signInAnonymously(firebaseAuth);
                                        setUser(result.user);
                                    }
                                } else {
                                    const result = await signInAnonymously(firebaseAuth);
                                    setUser(result.user);
                                }
                            }
                            setIsAuthReady(true);
                        });
                    } catch (error) {
                        console.error("Firebase init failed:", error);
                        setErrorMessage("การเชื่อมต่อ Firebase ล้มเหลว: " + error.message);
                        setIsAuthReady(true);
                    }
                };
                initFirebase();
            }, []);

            // Fetch orders
            u
